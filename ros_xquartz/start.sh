#!/bin/bash

# –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ ROS 2
source /opt/ros/jazzy/setup.bash

echo "=== ROS2 XQuartz Demo ==="
echo "–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:"
echo "1. XQuartz –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ"
echo "2. –†–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
echo "3. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ X11"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∏—Å–ø–ª–µ—è
if [ -z "$DISPLAY" ]; then
    echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DISPLAY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º -e DISPLAY=\$DISPLAY"
    exit 1
fi

echo "‚úÖ DISPLAY: $DISPLAY"

# –¢–µ—Å—Ç X11 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
echo "üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ X11 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
if command -v xeyes > /dev/null; then
    timeout 3 xeyes &
    X11_PID=$!
    sleep 1
    if kill -0 $X11_PID 2>/dev/null; then
        echo "‚úÖ X11 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
        kill $X11_PID
    else
        echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å X11 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º"
    fi
else
    echo "‚ö†Ô∏è  xeyes –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º turtlesim
echo "üê¢ –ó–∞–ø—É—Å–∫ TurtleSim..."
ros2 run turtlesim turtlesim_node &
TURTLE_PID=$!

# –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ turtlesim –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if kill -0 $TURTLE_PID 2>/dev/null; then
    echo "‚úÖ TurtleSim –∑–∞–ø—É—â–µ–Ω (PID: $TURTLE_PID)"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å TurtleSim"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–µ–º–æ
cd /ros_workspace
echo "üéÆ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
python3 src/demo/main.py